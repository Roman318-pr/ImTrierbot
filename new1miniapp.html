<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–¶–≤–µ—Ç–Ω–æ–π –±–∞–Ω–∫ ¬∑ TON —Ç—É—Ä–Ω–∏—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            align-items: center;
            padding: 16px;
            margin: 0;
        }
        .app-container {
            width: 100%;
            max-width: 420px;
            height: 100vh;
            max-height: 780px;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            background: #000;
            border-radius: 24px 24px 0 0;
            overflow: hidden;
        }

        /* –°—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω */
        .online-counter {
            background: #0a0a0a;
            padding: 12px 20px;
            border-bottom: 1px solid #1f1f1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }
        .online-count {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 10px;
            background: #2ecc71;
            box-shadow: 0 0 10px #2ecc71;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* –ë–∞–ª–∞–Ω—Å TON */
        .ton-balance {
            background: #0a0a0a;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #1f1f1f;
        }
        .wallet-info {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1a1a1a;
            padding: 6px 16px;
            border-radius: 40px;
            border: 1px solid #0088cc;
        }
        .ton-icon {
            font-size: 18px;
        }
        .ton-value {
            font-size: 16px;
            font-weight: bold;
            color: #0088cc;
        }
        .connect-wallet-btn {
            background: #0088cc;
            border: none;
            padding: 8px 16px;
            border-radius: 30px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .connect-wallet-btn.connected {
            background: #2a2a2a;
            color: #0088cc;
            border: 1px solid #0088cc;
        }
        .connect-wallet-btn:active {
            transform: scale(0.95);
            background: #006699;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1 1 auto;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            flex-direction: column;
            overflow-y: auto;
        }
        .tab-content.active {
            display: flex;
        }

        .wheels-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 28px;
            padding: 20px 12px 20px 12px;
            width: 100%;
        }

        .wheel-container {
            width: 100%;
            position: relative;
        }

        .wheel-pointer {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-top: 25px solid #ff4444;
            filter: drop-shadow(0 0 8px #ff4444);
            z-index: 10;
            animation: pointerGlow 1.5s infinite alternate;
        }
        @keyframes pointerGlow {
            from { filter: drop-shadow(0 0 5px #ff4444); }
            to { filter: drop-shadow(0 0 15px #ff4444); }
        }

        .pointer-result {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 10px rgba(255,68,68,0.5);
            z-index: 10;
        }

        .wheel {
            width: 100%;
            background: #0f0f0f;
            border-radius: 44px;
            padding: 14px 8px;
            border: 1px solid #2a2a2a;
        }
        .wheel-label {
            font-size: 13px;
            font-weight: 500;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #aaa;
            margin-bottom: 10px;
            margin-left: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .player-indicator {
            font-size: 11px;
            background: #1a1a1a;
            padding: 4px 10px;
            border-radius: 30px;
            color: #888;
            margin-right: 12px;
        }
        .player-indicator.ready {
            color: #2ecc71;
            background: #1a3a1a;
        }
        .card-scroll {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
            padding: 6px 16px;
            scroll-snap-type: x mandatory;
            -webkit-overflow-scrolling: touch;
            pointer-events: none;
        }
        .card-scroll::-webkit-scrollbar {
            display: none;
        }

        .color-card {
            flex: 0 0 auto;
            width: 90px;
            height: 110px;
            border-radius: 24px;
            background: #1e1e1e;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 6px 12px rgba(0,0,0,0.7);
            scroll-snap-align: center;
            border: 2px solid #333;
        }
        .color-preview {
            width: 50px;
            height: 50px;
            border-radius: 16px;
            margin-bottom: 10px;
            border: 2px solid #3d3d3d;
        }
        .color-name {
            font-size: 15px;
            font-weight: 600;
            text-transform: lowercase;
            background: rgba(0,0,0,0.5);
            padding: 4px 12px;
            border-radius: 40px;
            border: 1px solid #3a3a3a;
        }

        /* –û–±–ª–∞—Å—Ç—å —Å—Ç–∞–≤–æ–∫ */
        .bet-area {
            background: #0f0f0f;
            border-radius: 30px;
            margin: 10px 20px;
            padding: 15px;
            border: 1px solid #2a2a2a;
        }

        .bet-title {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }

        .color-bet-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .color-bet-btn {
            border: none;
            padding: 12px;
            border-radius: 30px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        .color-bet-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.2);
        }
        .color-bet-btn:active {
            transform: scale(0.95);
        }

        .bet-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .bet-input {
            flex: 1;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 30px;
            padding: 12px 20px;
            color: #fff;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
        }

        .bet-input:focus {
            outline: none;
            border-color: #0088cc;
        }

        .bet-info {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            color: #aaa;
            font-size: 12px;
        }

        .play-area {
            padding: 10px 20px 20px 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .play-button {
            background: #2a2a2a;
            border: none;
            padding: 18px 0;
            font-size: 20px;
            font-weight: 700;
            color: #808080;
            text-align: center;
            border-radius: 60px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.8);
            transition: all 0.2s ease;
            letter-spacing: 1px;
            border: 1px solid #3d3d3d;
        }
        .play-button.active {
            background: #2ecc71;
            color: #ffffff;
            box-shadow: 0 0 20px #2ecc71;
            border-color: #2ecc71;
        }
        .play-button:active {
            transform: scale(0.96);
        }
        .play-button.disabled {
            opacity: 0.5;
            pointer-events: none;
        }

        .players-status {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 13px;
            padding: 0 10px;
        }
        .player-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 10px;
            background: #444;
        }
        .status-dot.ready {
            background: #2ecc71;
            box-shadow: 0 0 8px #2ecc71;
        }

        /* –í–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ */
        .wallet-tab {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .wallet-title {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .wallet-address {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 20px;
            font-family: monospace;
            font-size: 14px;
            color: #0088cc;
            border: 1px solid #333;
            margin-bottom: 20px;
            word-break: break-all;
        }

        .wallet-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #0f0f0f;
            border-radius: 20px;
            padding: 20px;
            text-align: center;
            border: 1px solid #333;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #aaa;
            font-size: 12px;
        }

        .history-list {
            background: #0f0f0f;
            border-radius: 20px;
            padding: 15px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-win {
            color: #2ecc71;
        }

        .history-loss {
            color: #ff4444;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç—É—Ä–Ω–∏—Ä–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã */
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #222;
        }
        .leaderboard-rank {
            font-weight: bold;
            width: 30px;
            color: #0088cc;
        }
        .leaderboard-name {
            flex: 1;
            margin-left: 10px;
        }
        .leaderboard-points {
            font-weight: bold;
            color: #2ecc71;
        }
        .leaderboard-top1 .leaderboard-rank { color: #ffd700; }
        .leaderboard-top2 .leaderboard-rank { color: #c0c0c0; }
        .leaderboard-top3 .leaderboard-rank { color: #cd7f32; }

        .bottom-nav {
            width: 100%;
            background: #0a0a0a;
            border-top: 1px solid #1f1f1f;
            border-radius: 30px 30px 0 0;
            padding: 16px 12px 24px 12px;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-around;
            align-items: center;
            gap: 8px;
        }
        .nav-btn {
            flex: 1;
            background: #121212;
            border: none;
            padding: 14px 0;
            font-size: 16px;
            font-weight: 600;
            color: #808080;
            text-align: center;
            border-radius: 40px;
            transition: all 0.2s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        .nav-btn.active-nav {
            color: #ffffff !important;
            background: #2a2a2a;
        }

        @media (max-width: 380px) {
            .color-card {
                width: 75px;
                height: 100px;
            }
            .color-preview {
                width: 40px;
                height: 40px;
            }
        }
    </style>
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- TON Connect UI -->
    <script src="https://unpkg.com/@tonconnect/ui@2.0.3/dist/tonconnect-ui.min.js"></script>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–Ω–æ–ø–∫–∏ TON Connect -->
    <div id="ton-connect-button" style="display: none;"></div>
</head>
<body>
<div class="app-container">
    <!-- –°—á–µ—Ç—á–∏–∫ –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω -->
    <div class="online-counter">
        <div class="online-count">
            <span class="online-dot"></span>
            <span id="onlineCount">0</span> –∏–≥—Ä–æ–∫–æ–≤ –æ–Ω–ª–∞–π–Ω
        </div>
        <div class="room-info">
            üé∞ –∫–æ–º–Ω–∞—Ç–∞ #1
        </div>
    </div>

    <!-- –ë–∞–ª–∞–Ω—Å TON -->
    <div class="ton-balance">
        <div class="wallet-info" id="walletInfo">
            <span class="ton-icon">üíé</span>
            <span class="ton-value" id="tonBalance">0</span>
        </div>
        <button class="connect-wallet-btn" id="connectWalletBtn" onclick="connectWallet()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫</button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content">
        <!-- –í–∫–ª–∞–¥–∫–∞ —Å —Ä—É–ª–µ—Ç–∫–∞–º–∏ -->
        <div class="tab-content active" id="gameTab">
            <div class="wheels-area">
                <!-- –†—É–ª–µ—Ç–∫–∞ -->
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="pointer-result" id="wheel1Result">‚ö° deep blue</div>
                    <div class="wheel">
                        <div class="wheel-label">
                            üé° —Ü–≤–µ—Ç–Ω–∞—è —Ä—É–ª–µ—Ç–∫–∞
                            <span class="player-indicator" id="wheel1Indicator">üë§ –∂–¥–µ—Ç –∏–≥—Ä–æ–∫–∞</span>
                        </div>
                        <div class="card-scroll" id="wheel1"></div>
                    </div>
                </div>

                <!-- –û–±–ª–∞—Å—Ç—å —Å—Ç–∞–≤–æ–∫ -->
                <div class="bet-area">
                    <div class="bet-title">
                        <span>üí∞ –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</span>
                        <span>–ë–∞–Ω–∫: <span id="totalPool">0</span> TON</span>
                    </div>

                    <div class="color-bet-grid">
                        <button class="color-bet-btn" style="background: #1E3A8A;" onclick="placeBetOnColor('deep blue')">üîµ –°–∏–Ω–∏–π</button>
                        <button class="color-bet-btn" style="background: #06B6D4;" onclick="placeBetOnColor('cyan')">ü©µ –ì–æ–ª—É–±–æ–π</button>
                        <button class="color-bet-btn" style="background: #4F46E5;" onclick="placeBetOnColor('indigo')">üíú –ò–Ω–¥–∏–≥–æ</button>
                        <button class="color-bet-btn" style="background: #14B8A6;" onclick="placeBetOnColor('teal')">üíö –ë–∏—Ä—é–∑–∞</button>
                        <button class="color-bet-btn" style="background: #0284C7;" onclick="placeBetOnColor('sky')">üíô –ù–µ–±–µ—Å–Ω—ã–π</button>
                        <button class="color-bet-btn" style="background: #6D28D9;" onclick="placeBetOnColor('violet')">üíú –§–∏–æ–ª–µ—Ç–æ–≤—ã–π</button>
                    </div>

                    <div class="bet-controls">
                        <input type="number" class="bet-input" id="betAmount" value="0.1" min="0.1" max="100" step="0.1">
                    </div>

                    <div class="bet-info">
                        <span>‚ö° –í–∞—à–∞ —Å—Ç–∞–≤–∫–∞: <span id="yourBets">0</span> TON</span>
                        <span>üìä –í—Å–µ–≥–æ —Å—Ç–∞–≤–æ–∫: <span id="totalBets">0</span></span>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –∏–≥—Ä—ã -->
                <div class="play-area">
                    <button class="play-button" id="playButton">‚ñ∂ –ò–ì–†–ê–¢–¨</button>
                    <div class="players-status">
                        <div class="player-status" id="player1Status">
                            <span class="status-dot"></span>
                            <span>–ò–≥—Ä–æ–∫ 1</span>
                        </div>
                        <div class="player-status" id="player2Status">
                            <span class="status-dot"></span>
                            <span>–ò–≥—Ä–æ–∫ 2</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –∫–æ—à–µ–ª—å–∫–∞ -->
        <div class="tab-content" id="walletTab">
            <div class="wallet-tab">
                <div class="wallet-header">
                    <span class="wallet-title">üíé TON –∫–æ—à–µ–ª–µ–∫</span>
                </div>

                <div class="wallet-address" id="walletAddress">
                    –ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω
                </div>

                <div class="wallet-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="walletBalance">0</div>
                        <div class="stat-label">–ë–∞–ª–∞–Ω—Å TON</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalGamesStat">0</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –∏–≥—Ä</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalWinsStat">0</div>
                        <div class="stat-label">–ü–æ–±–µ–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalEarnedStat">0</div>
                        <div class="stat-label">–í—ã–∏–≥—Ä–∞–Ω–æ TON</div>
                    </div>
                </div>

                <div class="history-list">
                    <div style="color: #aaa; margin-bottom: 15px;">üìú –ò—Å—Ç–æ—Ä–∏—è –∏–≥—Ä</div>
                    <div id="gameHistory"></div>
                </div>

                <button class="place-bet-btn" onclick="disconnectWallet()" style="background: #ff4444; margin-top: 20px;">
                    üîå –û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫
                </button>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ —Ç—É—Ä–Ω–∏—Ä–∞ -->
        <div class="tab-content" id="tournamentTab">
            <div class="wallet-tab">
                <div class="wallet-header">
                    <span class="wallet-title">üèÜ –¢—É—Ä–Ω–∏—Ä –Ω–µ–¥–µ–ª–∏</span>
                    <span class="wallet-address" style="background: #1a3a1a; color: #2ecc71;" id="tournamentTimer">6–¥ 23—á</span>
                </div>

                <div class="wallet-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="prizePool">0</div>
                        <div class="stat-label">–ü—Ä–∏–∑–æ–≤–æ–π —Ñ–æ–Ω–¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="yourPoints">0</div>
                        <div class="stat-label">–í–∞—à–∏ –æ—á–∫–∏</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="yourRank">-</div>
                        <div class="stat-label">–í–∞—à–µ –º–µ—Å—Ç–æ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="playersCount">0</div>
                        <div class="stat-label">–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤</div>
                    </div>
                </div>

                <div class="history-list">
                    <div style="color: #aaa; margin-bottom: 15px; display: flex; justify-content: space-between;">
                        <span>üèÖ –¢–æ–ø-10 –∏–≥—Ä–æ–∫–æ–≤</span>
                        <span>–û—á–∫–∏</span>
                    </div>
                    <div id="leaderboardList"></div>
                </div>

                <div style="margin-top: 20px; color: #aaa; font-size: 12px; text-align: center;">
                    ‚è∞ 1 –æ—á–∫–æ = 10 TON –≤—ã–∏–≥—Ä—ã—à–∞<br>
                    –ü—Ä–∏–∑—ã –≤—ã–ø–ª–∞—á–∏–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –∫–æ–Ω—Ü–µ –Ω–µ–¥–µ–ª–∏
                </div>
            </div>
        </div>
    </div>

    <!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="bottom-nav">
        <div class="nav-buttons" id="navContainer">
            <button class="nav-btn" data-nav="game">üé∞ –ò–≥—Ä–∞</button>
            <button class="nav-btn" data-nav="wallet">üíé –ö–æ—à–µ–ª–µ–∫</button>
            <button class="nav-btn" data-nav="tournament">üèÜ –¢—É—Ä–Ω–∏—Ä</button>
            <button class="nav-btn" data-nav="profile">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å</button>
        </div>
    </div>
</div>

<script>
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
    const tg = window.Telegram.WebApp;
    tg.expand();

    // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const user = tg.initDataUnsafe?.user;
    const userId = user?.id?.toString() || 'guest_' + Math.random().toString(36).substr(2, 9);
    const gameId = 'room_' + Math.floor(Math.random() * 1000);

    // ========== 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø FIREBASE ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCYeELUnimdyjt0MRfNYfREkGfrt7gUnao",
        authDomain: "imtrierbot.firebaseapp.com",
        databaseURL: "https://imtrierbot-default-rtdb.firebaseio.com",
        projectId: "imtrierbot",
        storageBucket: "imtrierbot.firebasestorage.app",
        messagingSenderId: "1062476104894",
        appId: "1:1062476104894:web:e00869e054a5f3628e0aef",
        measurementId: "G-QC8TLBE3V2"
      };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const userRef = database.ref('users/' + userId);
    const statsRef = userRef.child('stats');

    // ========== 2. TON CONNECT ==========
    let tonConnectUI = null;
    let walletConnected = false;
    let walletAddress = '';
    let tonBalance = 0;

    const tonBalanceEl = document.getElementById('tonBalance');
    const connectWalletBtn = document.getElementById('connectWalletBtn');
    const walletAddressEl = document.getElementById('walletAddress');
    const walletBalanceEl = document.getElementById('walletBalance');

    // –í–ê–® –ê–î–†–ï–° –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –°–¢–ê–í–û–ö
    const RECIPIENT_ADDRESS = 'UQBjrnhS04mxMkEpYGngrd_UnypAFaQaKQcpf81BuQEJs1-i';

    // –§—É–Ω–∫—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    function showSimpleAlert(message) {
        if (tg && tg.showPopup) {
            tg.showPopup({
                message: message,
                buttons: [{ text: 'OK', type: 'default' }]
            });
        } else {
            const div = document.createElement('div');
            div.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #1a1a1a;
                color: white;
                padding: 20px 30px;
                border-radius: 20px;
                border: 2px solid #0088cc;
                z-index: 10000;
                text-align: center;
                max-width: 80%;
                box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            `;
            div.innerHTML = `
                <div style="margin-bottom: 15px;">${message}</div>
                <button onclick="this.parentElement.remove()" style="
                    background: #0088cc;
                    border: none;
                    padding: 10px 30px;
                    border-radius: 30px;
                    color: white;
                    font-weight: bold;
                    cursor: pointer;
                ">OK</button>
            `;
            document.body.appendChild(div);
            setTimeout(() => div.remove(), 3000);
        }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TON Connect UI
    function initTonConnectUI() {
        if (typeof TON_CONNECT_UI === 'undefined') {
            console.error("TON Connect UI –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω");
            return false;
        }

        try {
            tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
                manifestUrl: 'https://roman318-pr.github.io/ImTrierbot/tonconnect-manifest.json',
                buttonRootId: 'ton-connect-button',
                uiOptions: {
                    walletsListConfiguration: {
                        includeWallets: [
                            {
                                appName: "telegram-wallet",
                                name: "Telegram Wallet",
                                imageUrl: "https://wallet.tg/images/logo-288.png",
                                aboutUrl: "https://wallet.tg/",
                                universalLink: "https://t.me/wallet/start",
                                bridgeUrl: "https://bridge.tonapi.io/bridge",
                                platforms: ["ios", "android", "macos", "windows", "linux"]
                            }
                        ]
                    },
                    actionsConfiguration: {
                        twaReturnUrl: 'https://t.me/ImTrierbot/ImTrier'
                    }
                }
            });

            console.log("TON Connect UI –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω");

            tonConnectUI.onStatusChange((walletInfo) => {
                console.log("–°—Ç–∞—Ç—É—Å –∫–æ—à–µ–ª—å–∫–∞:", walletInfo);

                if (walletInfo && walletInfo.account) {
                    walletConnected = true;
                    walletAddress = walletInfo.account.address;

                    fetchTONBalance(walletAddress);

                    connectWalletBtn.textContent = '‚úì –ö–æ—à–µ–ª–µ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                    connectWalletBtn.classList.add('connected');
                    walletAddressEl.textContent = formatAddress(walletAddress);

                    userRef.child('wallet').set({
                        address: walletAddress,
                        connected: true
                    });

                    showSimpleAlert('‚úÖ –ö–æ—à–µ–ª–µ–∫ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                } else {
                    walletConnected = false;
                    walletAddress = '';
                    tonBalance = 0;

                    connectWalletBtn.textContent = 'üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫';
                    connectWalletBtn.classList.remove('connected');
                    tonBalanceEl.textContent = '0';
                    walletAddressEl.textContent = '–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
                    walletBalanceEl.textContent = '0';
                }
            });

            return true;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:", error);
            return false;
        }
    }

    window.connectWallet = async function() {
        console.log("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–æ—à–µ–ª—å–∫–∞...");

        if (walletConnected) {
            switchTab('wallet');
            return;
        }

        if (!tonConnectUI) {
            const initialized = initTonConnectUI();
            if (!initialized) return;
        }

        try {
            await tonConnectUI.openModal();
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            showSimpleAlert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
        }
    };

    window.disconnectWallet = function() {
        if (tonConnectUI) {
            tonConnectUI.disconnect();
        }

        walletConnected = false;
        walletAddress = '';
        tonBalance = 0;

        connectWalletBtn.textContent = 'üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å –∫–æ—à–µ–ª–µ–∫';
        connectWalletBtn.classList.remove('connected');
        tonBalanceEl.textContent = '0';
        walletAddressEl.textContent = '–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
        walletBalanceEl.textContent = '0';

        userRef.child('wallet').remove();
        showSimpleAlert('üîå –ö–æ—à–µ–ª–µ–∫ –æ—Ç–∫–ª—é—á–µ–Ω');
    };

    async function fetchTONBalance(address) {
        try {
            const response = await fetch(`https://toncenter.com/api/v2/getAddressBalance?address=${address}`);
            const data = await response.json();

            if (data.ok) {
                tonBalance = data.result / 1e9;
                tonBalanceEl.textContent = tonBalance.toFixed(2);
                walletBalanceEl.textContent = tonBalance.toFixed(2);
            }
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –±–∞–ª–∞–Ω—Å–∞:", error);
        }
    }

    function formatAddress(address) {
        if (!address) return '–ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω';
        return address.slice(0, 6) + '...' + address.slice(-4);
    }

    // ========== 3. –¶–í–ï–¢–ù–´–ï –ö–ê–†–¢–û–ß–ö–ò ==========
    const colors = [
        { name: 'deep blue', hex: '#1E3A8A' },
        { name: 'cyan', hex: '#06B6D4' },
        { name: 'indigo', hex: '#4F46E5' },
        { name: 'teal', hex: '#14B8A6' },
        { name: 'sky', hex: '#0284C7' },
        { name: 'violet', hex: '#6D28D9' }
    ];

    function fillWheel(containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        for (let i = 0; i < 30; i++) {
            let col = colors[i % colors.length];
            let card = document.createElement('div');
            card.className = 'color-card';
            card.innerHTML = `<div class="color-preview" style="background:${col.hex};"></div>
                              <span class="color-name">${col.name}</span>`;
            container.appendChild(card);
        }
    }

    fillWheel('wheel1');

    // ========== 4. –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö ==========
    const gameTab = document.getElementById('gameTab');
    const walletTab = document.getElementById('walletTab');
    const tournamentTab = document.getElementById('tournamentTab');
    const navButtons = document.querySelectorAll('.nav-btn');

    window.switchTab = function(tabId) {
        gameTab.classList.remove('active');
        walletTab.classList.remove('active');
        tournamentTab.classList.remove('active');

        if (tabId === 'game') {
            gameTab.classList.add('active');
        } else if (tabId === 'wallet') {
            walletTab.classList.add('active');
            loadWalletStats();
        } else if (tabId === 'tournament') {
            tournamentTab.classList.add('active');
            loadLeaderboard();
        }

        navButtons.forEach(btn => {
            btn.classList.remove('active-nav');
            if (btn.dataset.nav === tabId) {
                btn.classList.add('active-nav');
            }
        });
    };

    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            switchTab(btn.dataset.nav);
        });
    });

    // ========== 5. –õ–û–ì–ò–ö–ê –°–¢–ê–í–û–ö ==========
    let currentBets = {};
    colors.forEach(c => {
        currentBets[c.name] = { total: 0, players: {} };
    });

    let tournamentData = {
        week: 1,
        prizePool: 0,
        players: {},
        endTime: Date.now() + 7 * 24 * 60 * 60 * 1000
    };

    const betAmountInput = document.getElementById('betAmount');
    const yourBetsEl = document.getElementById('yourBets');
    const totalBetsEl = document.getElementById('totalBets');
    const totalPoolEl = document.getElementById('totalPool');

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    async function sendBetTransaction(amount) {
        if (!tonConnectUI || !walletConnected) {
            showSimpleAlert('‚ùå –ö–æ—à–µ–ª–µ–∫ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω');
            return false;
        }

        try {
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600,
                messages: [
                    {
                        address: RECIPIENT_ADDRESS,
                        amount: (amount * 1e9).toString(),
                        payload: '–°—Ç–∞–≤–∫–∞ –≤ Color Roulette'
                    }
                ]
            };

            const result = await tonConnectUI.sendTransaction(transaction);
            console.log("–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:", result);

            return { success: true, boc: result.boc };

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:", error);
            if (error.message?.includes('rejected')) {
                showSimpleAlert('‚ùå –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞');
            } else {
                showSimpleAlert('‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏');
            }
            return false;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—ã–∏–≥—Ä—ã—à–∞
    async function sendWinTransaction(amount, address) {
        if (!tonConnectUI || !walletConnected) return false;

        try {
            const transaction = {
                validUntil: Math.floor(Date.now() / 1000) + 600,
                messages: [
                    {
                        address: address,
                        amount: (amount * 1e9).toString(),
                        payload: 'üéâ –í—ã–∏–≥—Ä—ã—à'
                    }
                ]
            };

            await tonConnectUI.sendTransaction(transaction);
            return true;
        } catch (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—ã–ø–ª–∞—Ç—ã:", error);
            return false;
        }
    }

    // –°—Ç–∞–≤–∫–∞ –Ω–∞ —Ü–≤–µ—Ç
    window.placeBetOnColor = async function(color) {
        const betAmount = parseFloat(betAmountInput.value);

        if (isNaN(betAmount) || betAmount < 0.1) {
            showSimpleAlert('–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: 0.1 TON');
            return;
        }

        if (!walletConnected) {
            showSimpleAlert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫');
            connectWallet();
            return;
        }

        if (betAmount > tonBalance) {
            showSimpleAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ TON');
            return;
        }

        const result = await sendBetTransaction(betAmount);

        if (result && result.success) {
            currentBets[color].total += betAmount;
            currentBets[color].players[userId] = (currentBets[color].players[userId] || 0) + betAmount;

            tournamentData.prizePool += betAmount * 0.1;

            await database.ref('bets/' + gameId).set(currentBets);
            await database.ref('tournament').set(tournamentData);

            showSimpleAlert(`‚úÖ –°—Ç–∞–≤–∫–∞ ${betAmount} TON –Ω–∞ ${color} –ø—Ä–∏–Ω—è—Ç–∞!`);

            updateBetsUI();
        }
    };

    function updateBetsUI() {
        const total = Object.values(currentBets).reduce((sum, b) => sum + b.total, 0);
        totalBetsEl.textContent = total.toFixed(2);
        totalPoolEl.textContent = total.toFixed(2);

        const userTotal = Object.values(currentBets).reduce((sum, b) =>
            sum + (b.players[userId] || 0), 0);
        yourBetsEl.textContent = userTotal.toFixed(2);
    }

    // ========== 6. –ò–ì–†–û–í–ê–Ø –õ–û–ì–ò–ö–ê ==========
    const playButton = document.getElementById('playButton');
    const player1Status = document.getElementById('player1Status');
    const player2Status = document.getElementById('player2Status');
    const wheel1Indicator = document.getElementById('wheel1Indicator');
    const wheel2Indicator = document.getElementById('wheel2Indicator');
    const onlineCountSpan = document.getElementById('onlineCount');
    const wheel1Result = document.getElementById('wheel1Result');
    const wheel1Element = document.getElementById('wheel1');

    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞
    const playersRef = database.ref('players');
    const playerRef = playersRef.child(userId);

    playerRef.set({
        id: userId,
        ready: false,
        online: true
    });

    playerRef.onDisconnect().remove();

    playersRef.on('value', (snapshot) => {
        const players = snapshot.val() || {};
        const playerCount = Object.keys(players).length;
        onlineCountSpan.textContent = playerCount;

        let readyCount = 0;
        Object.values(players).forEach(p => {
            if (p.ready) readyCount++;
        });

        if (readyCount === 2) {
            playButton.classList.add('active');
            playButton.disabled = false;
        } else {
            playButton.classList.remove('active');
        }

        if (playerCount < 2) {
            playButton.classList.add('disabled');
            playButton.textContent = '‚ñ∂ –∂–¥–µ–º –≤—Ç–æ—Ä–æ–≥–æ –∏–≥—Ä–æ–∫–∞...';
        } else {
            playButton.classList.remove('disabled');
            playButton.textContent = '‚ñ∂ –ò–ì–†–ê–¢–¨';
        }
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–æ–±–µ–¥–∏—Ç–µ–ª—è
    function getWinningColor() {
        const total = Object.values(currentBets).reduce((sum, b) => sum + b.total, 0);
        if (total === 0) return colors[Math.floor(Math.random() * colors.length)].name;

        const rand = Math.random() * total;
        let cumulative = 0;

        for (let color of colors) {
            cumulative += currentBets[color.name].total;
            if (rand < cumulative) {
                return color.name;
            }
        }
        return colors[0].name;
    }

    playButton.addEventListener('click', () => {
        const total = Object.values(currentBets).reduce((sum, b) => sum + b.total, 0);
        if (total === 0) {
            showSimpleAlert('–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π—Ç–µ —Å—Ç–∞–≤–∫–∏!');
            return;
        }

        playerRef.update({ ready: true });

        playersRef.once('value', (snapshot) => {
            const players = snapshot.val() || {};
            const readyPlayers = Object.values(players).filter(p => p.ready).length;

            if (readyPlayers === 2) {
                startSpin();
            }
        });
    });

    function startSpin() {
        playButton.textContent = '‚è≥ –ö–†–£–¢–ò–ú...';
        playButton.classList.remove('active');

        const maxScroll = wheel1Element.scrollWidth - wheel1Element.clientWidth;
        const target = Math.random() * maxScroll;

        let startTime = null;
        const duration = 2000;

        function animate(currentTime) {
            if (!startTime) startTime = currentTime;
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easeOut = 1 - Math.pow(1 - progress, 3);

            wheel1Element.scrollLeft = target * easeOut;

            if (progress < 1) {
                requestAnimationFrame(animate);
            } else {
                playButton.textContent = '‚ñ∂ –ò–ì–†–ê–¢–¨';
                resolveGame();
            }
        }

        requestAnimationFrame(animate);
    }

    async function resolveGame() {
        const winningColor = getWinningColor();
        const totalPool = Object.values(currentBets).reduce((sum, b) => sum + b.total, 0);
        const winners = currentBets[winningColor].players;

        wheel1Result.textContent = `üèÜ ${winningColor}`;

        // –í—ã–ø–ª–∞—á–∏–≤–∞–µ–º –≤—ã–∏–≥—Ä—ã—à–∏
        for (let [playerId, betAmount] of Object.entries(winners)) {
            const winAmount = (betAmount / currentBets[winningColor].total) * totalPool;

            if (playerId !== 'guest') {
                await sendWinTransaction(winAmount, playerId);

                const points = Math.floor(winAmount / 10);
                tournamentData.players[playerId] = (tournamentData.players[playerId] || 0) + points;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
        const gameResult = {
            date: Date.now(),
            winningColor: winningColor,
            totalPool: totalPool,
            bets: currentBets
        };

        await database.ref('games/' + gameId).push(gameResult);
        await database.ref('tournament').set(tournamentData);

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞–≤–∫–∏
        colors.forEach(c => {
            currentBets[c.name] = { total: 0, players: {} };
        });

        await database.ref('bets/' + gameId).set(currentBets);
        updateBetsUI();

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å
        playersRef.once('value', (snapshot) => {
            const players = snapshot.val() || {};
            Object.keys(players).forEach(id => {
                playersRef.child(id).update({ ready: false });
            });
        });
    }

    // ========== 7. –¢–£–†–ù–ò–†–ù–ê–Ø –õ–û–ì–ò–ö–ê ==========
    function loadLeaderboard() {
        database.ref('tournament').once('value', (snapshot) => {
            const data = snapshot.val();
            if (data) {
                tournamentData = data;
                updateLeaderboardUI();
            }
        });
    }

    function updateLeaderboardUI() {
        document.getElementById('prizePool').textContent = tournamentData.prizePool.toFixed(2);
        document.getElementById('playersCount').textContent = Object.keys(tournamentData.players).length;

        const userPoints = tournamentData.players[userId] || 0;
        document.getElementById('yourPoints').textContent = userPoints;

        const sorted = Object.entries(tournamentData.players)
            .sort(([,a], [,b]) => b - a);

        const userRank = sorted.findIndex(([id]) => id === userId) + 1;
        document.getElementById('yourRank').textContent = userRank || '-';

        const leaderboardEl = document.getElementById('leaderboardList');
        leaderboardEl.innerHTML = '';

        sorted.slice(0, 10).forEach(([playerId, points], index) => {
            const rankClass = index === 0 ? 'leaderboard-top1' :
                             index === 1 ? 'leaderboard-top2' :
                             index === 2 ? 'leaderboard-top3' : '';

            const item = document.createElement('div');
            item.className = `leaderboard-item ${rankClass}`;
            item.innerHTML = `
                <span class="leaderboard-rank">#${index + 1}</span>
                <span class="leaderboard-name">${playerId.slice(0, 8)}...</span>
                <span class="leaderboard-points">${points}</span>
            `;
            leaderboardEl.appendChild(item);
        });

        updateTournamentTimer();
    }

    function updateTournamentTimer() {
        const now = Date.now();
        const timeLeft = tournamentData.endTime - now;

        if (timeLeft <= 0) {
            distributeTournamentPrizes();
            return;
        }

        const days = Math.floor(timeLeft / (24 * 60 * 60 * 1000));
        const hours = Math.floor((timeLeft % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));

        document.getElementById('tournamentTimer').textContent = `${days}–¥ ${hours}—á`;
    }

    async function distributeTournamentPrizes() {
        const sorted = Object.entries(tournamentData.players)
            .sort(([,a], [,b]) => b - a);

        const prizes = [0.3, 0.2, 0.15, 0.1, 0.08, 0.05, 0.04, 0.03, 0.03, 0.02];

        for (let i = 0; i < Math.min(10, sorted.length); i++) {
            const [playerId] = sorted[i];
            const prizeAmount = tournamentData.prizePool * prizes[i];

            if (playerId !== 'guest') {
                await sendWinTransaction(prizeAmount, playerId);
            }
        }

        tournamentData = {
            week: tournamentData.week + 1,
            prizePool: 0,
            players: {},
            endTime: Date.now() + 7 * 24 * 60 * 60 * 1000
        };

        await database.ref('tournament').set(tournamentData);
        updateLeaderboardUI();
    }

    // ========== 8. –°–¢–ê–¢–ò–°–¢–ò–ö–ê ==========
    function loadWalletStats() {
        statsRef.once('value', (snapshot) => {
            const stats = snapshot.val() || { games: 0, wins: 0, earned: 0 };
            document.getElementById('totalGamesStat').textContent = stats.games;
            document.getElementById('totalWinsStat').textContent = stats.wins;
            document.getElementById('totalEarnedStat').textContent = stats.earned;
        });

        database.ref('games/' + userId).limitToLast(10).once('value', (snapshot) => {
            const games = snapshot.val() || {};
            const historyEl = document.getElementById('gameHistory');
            historyEl.innerHTML = '';

            Object.values(games).reverse().forEach(game => {
                const date = new Date(game.date).toLocaleTimeString();
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <span>${date} | ${game.winningColor}</span>
                    <span>${game.totalPool} TON</span>
                `;
                historyEl.appendChild(item);
            });
        });
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    switchTab('game');
    setInterval(updateTournamentTimer, 60000);
</script>
</body>
</html>
